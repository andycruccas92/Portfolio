<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portfolio – Repository Viewer</title>
<meta name="description" content="Landing del portfolio con struttura repo navigabile." />
<style>
  :root{
    --bg:#0b0f14; --card:#111720; --muted:#9aa7b3; --text:#e8eef5; --accent:#7cc2ff; --line:#1c2532;
    --hover:#16202c; --tag:#1a2432; --ok:#59d191; --warn:#f0c36a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg, #0b0f14 0%, #0d141d 100%);
    color:var(--text); font:14.5px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  }
  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}
  header{
    position:sticky; top:0; z-index:5; backdrop-filter:saturate(130%) blur(6px);
    background:rgba(11,15,20,.7); border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1100px; margin:0 auto; padding:20px}
  .topbar{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .repo-title{font-weight:700; font-size:20px}
  .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:var(--tag); color:var(--muted); border:1px solid var(--line)}
  .controls{margin-left:auto; display:flex; align-items:center; gap:10px}
  .search{display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--line); border-radius:10px; padding:8px 10px}
  .search input{background:transparent; border:0; outline:none; color:var(--text); min-width:210px}
  .btn{
    background:var(--card); border:1px solid var(--line); color:var(--text);
    padding:8px 10px; border-radius:10px; cursor:pointer
  }
  .btn:hover{background:var(--hover)}
  main{padding: 8px 0 40px}
  .layout{display:grid; grid-template-columns: 320px 1fr; gap:18px}
  @media (max-width: 900px){ .layout{grid-template-columns:1fr} }

  .panel{background:var(--card); border:1px solid var(--line); border-radius:16px; overflow:hidden}
  .panel h3{margin:0; padding:14px 16px; border-bottom:1px solid var(--line); font-size:13px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
  .tree{padding:6px 0}
  .node{display:block; padding:8px 14px; border-bottom:1px dashed transparent}
  .node:hover{background:var(--hover)}
  .node .row{display:flex; gap:10px; align-items:center}
  .twist{width:18px; text-align:center; cursor:pointer; user-select:none}
  .icon{width:18px; text-align:center; opacity:.9}
  .name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .links{display:flex; gap:8px; opacity:.0; transition:opacity .15s}
  .node:hover .links{opacity:1}
  .link-chip{font-size:11px; padding:3px 7px; border-radius:8px; border:1px solid var(--line); background:#0f1620}
  .folder>.row .name{font-weight:600}
  .children{margin-left:24px; border-left:1px dashed var(--line); display:none}
  .folder.open>.children{display:block}
  .empty{padding:14px; color:var(--muted)}
  .readme{padding:16px}
  .readme h2{margin-top:0}
  .code{
    background:#0a0f16; border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:13px
  }

  .breadcrumb{display:flex; gap:8px; align-items:center; padding:10px 16px; border-bottom:1px solid var(--line)}
  .crumb{color:var(--muted)}
  .crumb a{color:var(--muted)}
  .crumb.sep{opacity:.4}
  .legend{padding:10px 16px; border-bottom:1px solid var(--line); color:var(--muted); display:flex; gap:10px; flex-wrap:wrap}
  .legend .pill{border:1px solid var(--line); border-radius:999px; padding:4px 8px; background:var(--tag)}
  footer{opacity:.7; font-size:12px; padding:20px 0}
</style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="repo-title">Portfolio</div>
    <span id="branch" class="badge">branch: …</span>
    <span id="count" class="badge">… items</span>
    <div class="controls">
      <div class="search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" placeholder="Cerca file o cartella…" />
      </div>
      <button id="expandAll" class="btn">Espandi</button>
      <button id="collapseAll" class="btn">Comprimi</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <section class="panel">
      <h3>Struttura repository</h3>
      <div class="breadcrumb" id="breadcrumb"></div>
      <div class="legend">
        <span class="pill">Cartelle in alto, poi file</span>
        <span class="pill">Click nome = seleziona</span>
        <span class="pill">View = Pages · Raw = sorgente · GitHub = UI</span>
      </div>
      <div id="tree" class="tree"></div>
    </section>

    <section class="panel">
      <h3>Dettagli / Anteprima</h3>
      <div id="details" class="readme">
        <div class="empty">Seleziona un file per vederne i dettagli. Se è <code>README.md</code> in root, lo mostro qui sotto.</div>
        <div id="readme"></div>
      </div>
    </section>
  </div>
  <footer>Generato in tempo reale dalla struttura GitHub della repo <strong>andycruccas92/Portfolio</strong>.</footer>
</main>

<script>
(async () => {
  const OWNER = "andycruccas92";
  const REPO  = "Portfolio";
  const api = (p) => `https://api.github.com${p}`;
  const pagesBase = () => `https://${OWNER}.github.io/${REPO}`;

  const branchEl = document.getElementById('branch');
  const countEl  = document.getElementById('count');
  const treeEl   = document.getElementById('tree');
  const qEl      = document.getElementById('q');
  const breadEl  = document.getElementById('breadcrumb');
  const readmeBox= document.getElementById('readme');

  // 1) Scopri default branch
  const repoInfo = await fetch(api(`/repos/${OWNER}/${REPO}`)).then(r=>r.json());
  const DEFAULT_BRANCH = repoInfo.default_branch || 'main';
  branchEl.textContent = `branch: ${DEFAULT_BRANCH}`;

  // 2) Carica struttura completa (ricorsivo)
  async function listDir(path=""){
    const url = api(`/repos/${OWNER}/${REPO}/contents/${path}?ref=${DEFAULT_BRANCH}`);
    const res = await fetch(url);
    if (!res.ok) throw new Error(`GitHub API error ${res.status}`);
    const items = await res.json();
    // Ordina: dir prima, poi file, alfabetico
    items.sort((a,b)=>{
      if (a.type!==b.type) return a.type==="dir"?-1:1;
      return a.name.localeCompare(b.name);
    });
    return items;
  }

  async function buildTree(path="", container){
    const items = await listDir(path);
    if (!items.length){
      const div = document.createElement('div');
      div.className = 'empty';
      div.textContent = 'Cartella vuota';
      container.appendChild(div);
      return;
    }
    count.total += items.length;
    for (const it of items){
      const isDir = it.type === 'dir';
      const node = document.createElement('div');
      node.className = 'node ' + (isDir? 'folder':'file');
      node.dataset.path = it.path;

      const row = document.createElement('div');
      row.className = 'row';

      const twist = document.createElement('div');
      twist.className = 'twist';
      twist.textContent = isDir ? '▸' : '';

      const icon = document.createElement('div');
      icon.className = 'icon';
      icon.textContent = isDir ? '📁' : fileIcon(it.name);

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = it.name;

      const links = document.createElement('div');
      links.className = 'links';
      if (!isDir){
        const rel = encodeURI(it.path);
        const view = document.createElement('a');
        view.className='link-chip'; view.textContent='View';
        view.href = `${pagesBase()}/${rel}`; view.target='_blank'; view.rel='noopener';

        const raw  = document.createElement('a');
        raw.className='link-chip'; raw.textContent='Raw';
        raw.href = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${DEFAULT_BRANCH}/${rel}`;
        raw.target='_blank'; raw.rel='noopener';

        const gh   = document.createElement('a');
        gh.className='link-chip'; gh.textContent='GitHub';
        gh.href = `https://github.com/${OWNER}/${REPO}/blob/${DEFAULT_BRANCH}/${rel}`;
        gh.target='_blank'; gh.rel='noopener';

        links.append(view, raw, gh);
      }

      row.append(twist, icon, name, links);
      node.appendChild(row);
      container.appendChild(node);

      // Click comportamenti
      if (isDir){
        const children = document.createElement('div');
        children.className = 'children';
        node.appendChild(children);

        const open = async () => {
          node.classList.toggle('open');
          twist.textContent = node.classList.contains('open') ? '▾' : '▸';
          if (!node.dataset.loaded && node.classList.contains('open')){
            node.dataset.loaded = 'y';
            await buildTree(it.path, children);
          }
          updateBreadcrumb(it.path);
        };
        twist.onclick = open;
        name.onclick  = open;
        icon.onclick  = open;
      } else {
        name.onclick = () => { selectFile(it); updateBreadcrumb(dirName(it.path)); };
        icon.onclick = () => { selectFile(it); updateBreadcrumb(dirName(it.path)); };
      }
    }
  }

  function updateBreadcrumb(path){
    const parts = path ? path.split('/') : [];
    breadEl.innerHTML = '';
    const root = document.createElement('span');
    root.className='crumb';
    const rootA = document.createElement('a'); rootA.href='#'; rootA.textContent='root';
    rootA.onclick = (e)=>{ e.preventDefault(); scrollToTop(); };
    root.appendChild(rootA);
    breadEl.appendChild(root);

    let built = '';
    parts.forEach((p,i)=>{
      const sep = document.createElement('span'); sep.className='crumb sep'; sep.textContent='›';
      breadEl.appendChild(sep);
      built += (i?'/':'') + p;
      const c = document.createElement('span'); c.className='crumb';
      const a = document.createElement('a'); a.href='#'; a.textContent=p;
      a.onclick = (e)=>{ e.preventDefault(); highlightFolder(built); };
      c.appendChild(a);
      breadEl.appendChild(c);
    });
  }

  function highlightFolder(path){
    // Try to open folders along the path
    const segments = path ? path.split('/') : [];
    let acc = '';
    for (let i=0;i<segments.length;i++){
      acc += (i?'/':'') + segments[i];
      const el = treeEl.querySelector(`.node.folder[data-path="${cssEsc(acc)}"]`);
      if (el && !el.classList.contains('open')){
        el.querySelector('.twist').click();
      }
    }
    const target = treeEl.querySelector(`.node.folder[data-path="${cssEsc(path)}"]`);
    if (target) target.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function scrollToTop(){ window.scrollTo({top:0, behavior:'smooth'}); }

  function fileIcon(name){
    const n = name.toLowerCase();
    if (n.endsWith('.md')) return '📝';
    if (n.endsWith('.png')||n.endsWith('.jpg')||n.endsWith('.jpeg')||n.endsWith('.gif')||n.endsWith('.webp')) return '🖼️';
    if (n.endsWith('.pdf')) return '📄';
    if (n.endsWith('.zip')||n.endsWith('.rar')||n.endsWith('.7z')) return '🗜️';
    if (n.endsWith('.html')||n.endsWith('.css')||n.endsWith('.js')||n.endsWith('.ts')) return '💻';
    if (n.endsWith('.xlsx')||n.endsWith('.xls')||n.endsWith('.csv')) return '📊';
    if (n.endsWith('.doc')||n.endsWith('.docx')) return '📃';
    return '📄';
  }

  function dirName(p){ const i=p.lastIndexOf('/'); return i>0 ? p.slice(0,i) : ''; }

  // 3) Ricerca client-side
  qEl.addEventListener('input', () => {
    const term = qEl.value.trim().toLowerCase();
    for (const node of treeEl.querySelectorAll('.node')){
      const name = node.querySelector('.name')?.textContent.toLowerCase() || '';
      const match = !term || name.includes(term);
      node.style.display = match ? '' : 'none';
      // auto-open parents when searching
      if (term && match){
        let cur = node;
        while (cur){
          if (cur.classList?.contains('folder')){
            cur.classList.add('open');
            const twist = cur.querySelector('.twist'); if (twist) twist.textContent='▾';
          }
          cur = cur.parentElement?.closest?.('.node.folder') || null;
        }
      }
    }
  });

  // 4) Espandi/Comprimi tutto
  document.getElementById('expandAll').onclick = async () => {
    for (const f of treeEl.querySelectorAll('.node.folder')){
      if (!f.classList.contains('open')) f.querySelector('.twist').click();
      // Se non ancora caricati, attende un tick
      await new Promise(r=>setTimeout(r, 15));
    }
  };
  document.getElementById('collapseAll').onclick = () => {
    for (const f of treeEl.querySelectorAll('.node.folder.open')){
      f.classList.remove('open');
      const t = f.querySelector('.twist'); if (t) t.textContent='▸';
    }
    updateBreadcrumb('');
  };

  // 5) Dettaglio file (mostra snippet per testo/markdown)
  async function selectFile(item){
    const ext = item.name.toLowerCase().split('.').pop();
    const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${DEFAULT_BRANCH}/${encodeURI(item.path)}`;
    let html = `<h2 style="margin:0 0 8px 0">${escapeHtml(item.name)}</h2>
      <div style="margin-bottom:12px">
        <a class="link-chip" href="${pagesBase()}/${encodeURI(item.path)}" target="_blank" rel="noopener">View</a>
        <a class="link-chip" href="${rawUrl}" target="_blank" rel="noopener">Raw</a>
        <a class="link-chip" href="https://github.com/${OWNER}/${REPO}/blob/${DEFAULT_BRANCH}/${encodeURI(item.path)}" target="_blank" rel="noopener">GitHub</a>
      </div>`;

    // Anteprima veloce solo per file di testo "piccoli"
    const textlike = ['md','txt','json','yaml','yml','xml','html','css','js','ts'];
    if (textlike.includes(ext)){
      try{
        const txt = await fetch(rawUrl).then(r=>r.text());
        const preview = txt.length>4000 ? txt.slice(0,4000) + "\n\n… (troncato)" : txt;
        html += `<div class="code"><pre>${escapeHtml(preview)}</pre></div>`;
      }catch(e){
        html += `<div class="empty">Impossibile caricare l’anteprima.</div>`;
      }
    } else {
      html += `<div class="empty">Nessuna anteprima disponibile per questo formato.</div>`;
    }
    document.getElementById('details').innerHTML = `<div class="readme">${html}<div id="readme"></div></div>`;
  }

  // 6) Carica README.md in root, se presente
  async function loadReadme(){
    try{
      const rd = await fetch(api(`/repos/${OWNER}/${REPO}/readme?ref=${DEFAULT_BRANCH}`)).then(r=>r.ok?r.json():null);
      if (!rd) return;
      const txt = await fetch(rd.download_url).then(r=>r.text());
      readmeBox.innerHTML = `
        <h2>README.md</h2>
        <div class="code"><pre>${escapeHtml(txt)}</pre></div>
      `;
    }catch(e){}
  }

  // 7) Helpers
  const count = { total: 0 };
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function cssEsc(s){ return CSS && CSS.escape ? CSS.escape(s) : s.replace(/"/g,'\\"'); }

  // Avvio
  await buildTree("", treeEl);
  await loadReadme();
  countEl.textContent = `${count.total} items`;
})();
</script>
</body>
</html>
